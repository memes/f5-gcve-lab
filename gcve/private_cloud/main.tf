terraform {
  required_version = ">= 1.2"
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = ">= 5.0"
    }
  }
}

data "google_compute_network" "vpc" {
  name    = regex("/([^/]+)$", var.vpc_self_link)[0]
  project = regex("projects/([^/]+)/", var.vpc_self_link)[0]
}

resource "google_vmwareengine_network" "network" {
  project     = var.project_id
  name        = var.name
  description = "Testing network"
  location    = "global"
  type        = "STANDARD"
}

resource "google_vmwareengine_network_peering" "peer" {
  project               = var.project_id
  name                  = var.name
  description           = "Peering with hub VPC"
  peer_network          = data.google_compute_network.vpc.id
  peer_network_type     = "STANDARD"
  vmware_engine_network = google_vmwareengine_network.network.id
}

resource "google_vmwareengine_private_cloud" "pc" {
  for_each = { for i, location in var.locations : location => {
    name            = format("%s-%d", var.name, i)
    management_name = format("%s-%d-mgmt", var.name, i)
    management_cidr = cidrsubnet("192.168.0.0/16", 8, i)
    network         = google_vmwareengine_network.network.id
  } }
  project     = var.project_id
  name        = each.value.name
  location    = each.key
  type        = "STANDARD"
  description = "Shared GCVE for Barrymore and Eric G."
  network_config {
    management_cidr       = each.value.management_cidr
    vmware_engine_network = each.value.network
  }
  management_cluster {
    cluster_id = each.value.management_name
    node_type_configs {
      node_count   = 3
      node_type_id = "standard-72"
    }
  }

  timeouts {
    create = "180m"
    delete = "60m"
  }
}
