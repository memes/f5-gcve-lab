terraform {
  required_version = ">= 1.2"
  required_providers {
    google = {
      source  = "hashicorp/google"
      version = ">= 5.0"
    }
    random = {
      source  = "hashicorp/random"
      version = ">= 3.6"
    }
  }
}

data "google_compute_zones" "zones" {
  for_each = toset(var.regions)
  project  = var.project_id
  region   = each.value
  status   = "UP"
}

resource "random_shuffle" "zones" {
  for_each = data.google_compute_zones.zones
  input    = each.value.names
}

resource "random_pet" "prefix" {
  length = 1
  prefix = var.prefix
  keepers = {
    project = var.project_id
  }
}

resource "google_project_service" "project" {
  for_each = toset([
    "dns.googleapis.com",
    "iap.googleapis.com",
    "vmwareengine.googleapis.com",
  ])
  project                    = var.project_id
  service                    = each.value
  disable_on_destroy         = false
  disable_dependent_services = false
}

resource "google_project_iam_member" "admin" {
  for_each = toset(var.gcve_admins)
  project  = var.project_id
  role     = "roles/vmwareengine.vmwareengineAdmin"
  member   = each.value
}

resource "google_project_iam_member" "viewer" {
  for_each = toset(var.gcve_viewers)
  project  = var.project_id
  role     = "roles/vmwareengine.vmwareengineViewer"
  member   = each.value
}
